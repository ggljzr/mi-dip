\chapter{Implementace}
\label{sec:im}

\section{Struktura aplikace}

%zaklad zakladni struktura aplikace zalozena na \url{https://www.digitalocean.com/community/tutorials/how-to-structure-large-flask-applications#working-with-modules-and-blueprints-(components)}

Aplikace nadřazeného systému je rozdělena do tří modulů:

\begin{itemize}
    \item \texttt{mod\_main} -- hlavní modul aplikace. V~tomto modulu je implementován \textit{model} systému popsaný v~sekci \ref{sec:de_model}. \textit{Model} je využíván i ostatními moduly (konkrétně modulem \texttt{mod\_api}). Dále tento modul implementuje webové rozhraní správy nadřazeného systému.
    \item \texttt{mod\_api} -- modul implementující API systému. Zde je implementován \textit{controller} ze sekce \ref{sec:de_api}, definující URL, pomocí kterých mohou podřízené systémy komunikovat s~nadřazeným systémem.
    \item \texttt{mod\_auth} -- modul implementující autentizaci uživatele při přihlašování do webového rozhraní.
\end{itemize}

Pro rozdělení aplikace na jednotlivé moduly jsem použíl nástroj frameworku Flask nazvaný \textit{blueprints} \cite{flask_blueprints}.

\section{Implementace \textit{modelu}}

%sqlalchemy

%scheduler http://apscheduler.readthedocs.io/en/v3.5.1/index.html,
%k cemu vsemu slouzi, ze je vicevlaknovej, proc je tam pouzitej


\subsection{Zasíláním upozornění}

%posilani mailu pomoci toho eventu zmeny v sqlalchemy

%posilani mailu obecne jak je implementovany

\section{Implementace \textit{view}}

%jinja, makra

%wtforms

%jquery na filtry

\section{Implementace \textit{controlleru}}

%csrf, viz  napsat ze pro add garage a revoke key misto normalni routy, getu a linku pouzivame formulare a post kvuli vochrane pred csrf, viz \url{https://stackoverflow.com/questions/6812765/how-to-demonstrate-a-csrf-attack}. Timhle utokem by nekdo moh vytvaret garaze a rusit api klice, coz neni naka velka skoda ale spis na votravovani no (u~vostatnich veci (tj hlavne change password) to bylo uz driv v~pohode protoze byly pouzity ty flaskforms)

\subsection{API \textit{controller}}

%vyjimka z csrf (neni potreba login, prokazuje se klicem)

\section{Autentizace uživatele}

%asi hlavne bcrypt popsat

%login_required decorator \url{http://flask.pocoo.org/docs/0.12/patterns/viewdecorators/}

%session

%mozna csrf tady, napsat jak je tam zapnuty, ze default je soucasti toho flask_formu ale my ho chceme pro vsechny ty post routy a pak vyjimku pro api modul -- tady napsat jak se nam siknou ty blueprinty

%v~testovani je mozny tenhle utok demonstrovat a ukazat jak pekne nam to funguje (voproti ty prvni verzi kde byl na add garage normalne get). Ted se pri tim pokusu vo utok normalne zvobrazi invalid csrf token nebo tak neco. Pro porovnani zmen puvodni a vopraveny verze viz commit e52a54b2caa8eead85e8df28c738356a7541a1c4 (password redirect, to je posledni verze s~timhle bugem)

\begin{listing}[htbp]
\caption{\label{code:foo} Testovací listing}
\begin{minted}[bgcolor=codebg]{python}
# ... code here ...

import numpy as np

def foo(a):
    print(a)

class FooBar:
    def __init__(self):
        self.b = 10

a = [1, 2, 3, 4]
for i in a:
    if i == 2:
        print("hello world")
\end{minted}
\end{listing}